<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reward Center</title>
	<link rel="stylesheet" href="points_event.css">    
</head>
<body>
	<div class="page-header">
        <h1>Reward Center</h1>
    </div>
	
    <div class="card">
        <h2>ğŸ“Š Last week's performance</h2>
        <p>Score: <span id="lastWeekScore">0</span> pts</p>
        <p>Rank: <span class="level-badge" id="currentLevel">Shaker</span></p>
        <p>This week's applicable boost buff: <span id="currentBuff">0.5%</span></p>
    </div>

    <div class="card">
        <h2>ğŸš€ Current progress</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="currentProgress"></div>
        </div>
        <p>Current rank: <span class="level-badge" id="nextLevel">Starter</span></p>
        <p id="nextLevelInfo">Next rank in: 51 pts</p>
		<p>Projected boost buff: <span id="nextBuff">0.5%</span></p>
    </div>

    <div class="card simulator collapsible">
        <div class="simulator-header" onclick="toggleSimulator()">
            <h2>ğŸ’¡ Earning simulator</h2>
            <span class="arrow">â–¼</span>
        </div>
        <div class="simulator-content">
            <p>Current balance: $<span id="currentBalance">0</span></p>
            <input type="range" id="balanceSimulator" min="0" max="1000" value="0">
            <div class="result-box">
                <p>Weekly earning: $<span id="weeklyEarn">0.00</span></p>
                <p>Daily earning: $<span id="dailyEarn">0.00</span></p>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ Activities</h2>
        <div id="activitiesList"></div>
    </div>
	
	<div class="back-to-top" onclick="scrollToTop()">â†‘</div>
	
    <script>
        // åˆå§‹æ•°æ®é…ç½®
        let userData = {};
	if('currentUserData' in localStorage){
		userData = JSON.parse(localStorage.getItem('currentUserData'));
	}else{
		userData = {
			lastWeekScore: 117,      // ä¸Šå‘¨å¾—åˆ†
			currentBalance: 80,    // å½“å‰ä½™é¢
			activities: {
				addCash: 30,
				referrals: 15,
				p2p: 17,
				crossBorder: 0,
				miniApps: 35,
				billPayments: 60
			}
		};
	}
	console.log(JSON.stringify(userData));

        // ç­‰çº§é…ç½®
        const LEVELS = [
            { name: 'Starter', min: 0, buff: 0.5 },
            { name: 'Mover', min: 51, buff: 1 },
            { name: 'Shaker', min: 151, buff: 1.5 },
            { name: 'Master', min: 301, buff: 2 }
        ];

        // æ´»åŠ¨é…ç½®
        const ACTIVITIES = [
			{ 
				id: 'addCash',
				label: 'Add cash',
				desc: '+10 points each time the user deposits',
				max: 30,
				getCurrent: () => userData.activities.addCash
			},
			{
				id: 'referrals',
				label: 'Referrals',
				desc: '+5 points for each valid referral',
				max: 30,
				getCurrent: () => userData.activities.referrals
			},
			{
				id: 'balance',
				label: 'Hold Higher balance',
				desc: 'Tiered points based on balance',
				max: 100,
				getCurrent: () => {
					const balance = userData.currentBalance;
					if (balance >= 500) return 100;
					if (balance >= 100) return 50;
					if (balance >= 50) return 20;
					if (balance >= 10) return 10;
					return 0;
				}
			},
			{
				id: 'p2p',
				label: 'P2P transactions',
				desc: '+3 pts per action',
				max: 20,
				getCurrent: () => userData.activities.p2p
			},
			{
				id: 'crossBorder',
				label: 'Cross-border Sends',
				desc: '+25 pts per action',
				max: 50,
				getCurrent: () => userData.activities.crossBorder
			},
			{
				id: 'miniApps',
				label: 'Mini App Usage',
				desc: '+10 pts per action',
				max: 70,
				getCurrent: () => userData.activities.miniApps
			},
			{
				id: 'billPayments',
				label: 'Bill Payments',
				desc: '+20 pts per action',
				max: 100,
				getCurrent: () => userData.activities.billPayments
			},
		];

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            // ä¸Šå‘¨æ•°æ®
            document.getElementById('lastWeekScore').textContent = userData.lastWeekScore;
            updateLevelDisplay(userData.lastWeekScore, true);

            // æœ¬å‘¨æ•°æ®
            const currentScore = calculateCurrentScore();
            updateLevelDisplay(currentScore);
            updateProgress(currentScore);

            // åˆå§‹åŒ–æ¨¡æ‹Ÿå™¨
            initSimulator();

            // åˆå§‹åŒ–æ´»åŠ¨åˆ—è¡¨
            initActivities();
        }

        // è®¡ç®—å½“å‰å¾—åˆ†ï¼ˆå«ä½™é¢è®¡ç®—ï¼‰
        function calculateCurrentScore() {
            let score = 0;
			// è®¡ç®—å…¶ä»–æ´»åŠ¨å¾—åˆ†ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰
			score += userData.activities.addCash;
			score += userData.activities.referrals;
			score += userData.activities.p2p;
			score += userData.activities.crossBorder;
			score += userData.activities.miniApps;
			score += userData.activities.billPayments;

			// è®¡ç®—çœŸå®ä½™é¢å¾—åˆ†
			const realBalance = userData.currentBalance;
			if (realBalance >= 500) score += 100;
			else if (realBalance >= 100) score += 50;
			else if (realBalance >= 50) score += 20;
			else if (realBalance >= 10) score += 10;

			return score;
        }

        // æ›´æ–°ç­‰çº§æ˜¾ç¤º
        function updateLevelDisplay(score, isLastWeek = false) {
			let currentLevel;
			for (let i = LEVELS.length - 1; i >= 0; i--) {
				if (score >= LEVELS[i].min) {
					currentLevel = LEVELS[i];
					break;
				}
			}
    
			const suffix = isLastWeek ? 'current' : 'next';
			console.log(suffix);
			document.getElementById(suffix+'Level').textContent = currentLevel.name;
			document.getElementById(suffix+'Buff').textContent = `${currentLevel.buff}%`;
		}

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(score) {
			let nextLevel = LEVELS.find(l => l.min > score);
			if (!nextLevel) {
				document.getElementById('nextLevelInfo').textContent = 'å·²è¾¾æœ€é«˜ç­‰çº§';
				document.querySelector('#currentProgress').style.width = '100%';
				return;
			}

			const currentLevel = LEVELS.find(l => l.min <= score && (LEVELS[LEVELS.indexOf(l)+1]?.min > score || !LEVELS[LEVELS.indexOf(l)+1]));
			const progress = (score - currentLevel.min) / (nextLevel.min - currentLevel.min) * 100;
			document.querySelector('#currentProgress').style.width = `${progress}%`;
			document.getElementById('nextLevelInfo').textContent = 
				`Next rank in: ${nextLevel.min - score} pts`;
		}

        // åˆå§‹åŒ–æ¨¡æ‹Ÿå™¨
        function initSimulator() {
			const simulator = document.getElementById('balanceSimulator');
			const balanceDisplay = document.getElementById('currentBalance');
			const weeklyEarn = document.getElementById('weeklyEarn');
			const dailyEarn = document.getElementById('dailyEarn');

			// ä½¿ç”¨ä¸´æ—¶å˜é‡å­˜å‚¨æ¨¡æ‹Ÿå€¼
			let simulatedBalance = userData.currentBalance;
			simulator.value = simulatedBalance;
			balanceDisplay.textContent = simulatedBalance;

			// ä¿®æ”¹äº‹ä»¶ç›‘å¬å™¨
			simulator.addEventListener('input', (e) => {
				// åªæ›´æ–°æ¨¡æ‹Ÿå€¼ï¼Œä¸ä¿®æ”¹çœŸå®æ•°æ®
				simulatedBalance = parseInt(e.target.value);

				// ä»…æ›´æ–°å½“å‰å¡ç‰‡çš„æ˜¾ç¤º
				balanceDisplay.textContent = simulatedBalance;

				// ä½¿ç”¨æ¨¡æ‹Ÿå€¼è®¡ç®—æ”¶ç›Š
				const buff = parseFloat(document.getElementById('currentBuff').textContent) / 100;
				const weekly = (simulatedBalance * buff).toFixed(2);
				const daily = (weekly / 7).toFixed(2);

				weeklyEarn.textContent = weekly;
				dailyEarn.textContent = daily;
			});
		}

        // åˆå§‹åŒ–æ´»åŠ¨åˆ—è¡¨
        function initActivities() {
			const container = document.getElementById('activitiesList');
			container.innerHTML = '';

			ACTIVITIES.forEach(activity => {
			// ä½¿ç”¨çœŸå®ç”¨æˆ·æ•°æ®åˆå§‹åŒ–
				const current = activity.getCurrent();
				const max = activity.max;
				const isFull = current >= max;
				const progress = Math.min((current / max) * 100, 100);

				const activityItem = document.createElement('div');
				activityItem.className ='activity-item';
				activityItem.innerHTML = `
				<h3>${activity.label}</h3>
				<p>${activity.desc} (Max: ${max} points)</p>
				<div class="progress-bar">
					<div class="progress-fill ${isFull ? 'full' : ''}" style="width: ${progress}%"></div>
				</div>
				<p>Current pts: ${current} ${isFull ? '<span class="max-tag">Reached Max</span>' : ''}</p>
				`;
				container.appendChild(activityItem);
			});
		}
		
		 function toggleCollapse(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('active');
            header.querySelector('.arrow').textContent = 
                content.classList.contains('active') ? 'â–²' : 'â–¼';
        }

        // è¿”å›é¡¶éƒ¨åŠŸèƒ½
        window.onscroll = function() {
            document.querySelector('.back-to-top').style.display = 
                (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) 
                ? 'flex' : 'none';
        };

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
		
		function toggleSimulator() {
			const simulator = document.querySelector('.simulator');
			const content = simulator.querySelector('.simulator-content');
			const arrow = simulator.querySelector('.arrow');

			simulator.classList.toggle('collapsed');
			arrow.textContent = simulator.classList.contains('collapsed') ? 'â–²' : 'â–¼';

			// è‡ªåŠ¨æ»šåŠ¨åˆ°é€‚å½“ä½ç½®
			if (!simulator.classList.contains('collapsed')) {
				setTimeout(() => {
					simulator.scrollIntoView({ behavior: 'smooth', block: 'center' });
				}, 300);
			}
		}

		// åˆå§‹åŒ–æ—¶æ ¹æ®å±å¹•å°ºå¯¸è‡ªåŠ¨æŠ˜å 
		function initCollapse() {
			if (window.innerHeight < 700) {
					document.querySelector('.simulator').classList.add('collapsed');
			}
		}
		window.addEventListener('load', initCollapse);
        // è¿è¡Œåˆå§‹åŒ–
        init();
    </script>
</body>
</html>
